# AGENTS.md - Operating Manual f√ºr AI-gest√ºtzte √Ñnderungen

**Version:** 1.2  
**Letzte Aktualisierung:** 25. Januar 2026  
**Status:** Verbindlich f√ºr alle AI-assistierten Code-√Ñnderungen

---

## A) PURPOSE / PRIME DIRECTIVE

Diese Regeln sind **NON-NEGOTIABLE**. Jede Abweichung f√ºhrt zu Database Drift, Production Bugs oder Data Loss.

### Kernregeln (1-10)

1. **NIEMALS** manuell in die Production- oder Staging-Datenbank schreiben (kein direktes SQL au√üer via Migration).
2. **JEDE Schema√§nderung** erfordert zwingend: Schema-Update ‚Üí Migration generieren ‚Üí Migration apply ‚Üí Tests gr√ºn.
3. **KEINE alte Migration darf modifiziert oder gel√∂scht werden** nach Apply auf Production/Staging.
4. **KEINE Feature-Implementierung gilt als fertig**, solange nicht: Schema migriert + Code ge√§ndert + Tests gr√ºn + Dokumentation aktualisiert.
5. **Breaking Changes** m√ºssen in mindestens 2 Phasen erfolgen (z.B. Spalte zuerst nullable + Backfill, dann constraint).
6. **IMMER lokale Quality Gates laufen lassen** vor Commit: Lint ‚Üí Typecheck ‚Üí Build ‚Üí (Tests wenn vorhanden).
7. **KEINE hardcoded Secrets, URLs oder Connection Strings** im Code committen.
8. **Default Workflow**: Kleine, isolierte √Ñnderungen. Keine "Big Bang" Refactorings ohne explizite Anweisung.
9. **Bei Unsicherheit STOP**: Dokumentiere fehlende Fakten, stelle max. 3 pr√§zise Fragen, schlage konkrete Optionen vor.
10. **Jede DB-√Ñnderung muss tracked sein**: Migration File + Journal Entry + Apply Log.

---

## B) STACK FACTS (aus Repository extrahiert)

### Sprache & Framework
- **Sprache:** TypeScript 5.x
- **Framework:** Next.js 16 (App Router)
- **Runtime:** Node.js 20+
- **Package Manager:** npm (erkennbar an `package.json` ohne `pnpm-lock.yaml` oder `bun.lockb`)

### Datenbank & ORM
- **Datenbank:** Neon PostgreSQL (Serverless)
- **ORM:** Drizzle ORM v0.45.0
- **Driver:** `@neondatabase/serverless` v1.0.2
- **Drizzle Kit:** v0.31.8

### Schema & Migrationen
- **Schema Source-of-Truth:** `src/db/schema.ts`
- **Drizzle Config:** `drizzle.config.ts` (root)
- **Migrations Ordner:** `drizzle/` (root)
- **Migration Naming:** `<INDEX>_<descriptor>.sql` (z.B. `0000_wandering_zarek.sql`, `0001_add_target_role.sql`)
- **Journal:** `drizzle/meta/_journal.json` (automatisch von drizzle-kit verwaltet)

### DB Connection Handling
- **ENV Variable:** `DATABASE_URL` (required, kein Default)
- **Connection Pattern:** Lazy Singleton via Proxy (`src/db/index.ts`)
- **Driver:** Neon HTTP-basiert (nicht WebSocket)
- **ENV File:** `.env.local` (geladen via `dotenv.config({ path: ".env.local" })` in Scripts, automatisch von Next.js)

### Auth
- **Library:** Auth.js v5 (NextAuth)
- **ENV Variable:** `AUTH_SECRET` (required f√ºr JWT signing)

### Build & Quality Tools
- **Linter:** ESLint (config: `eslint.config.mjs`)
- **Type Checker:** TypeScript Compiler (tsc via Next.js build)
- **Test Runner:** ‚ùå NICHT VORHANDEN (TODO: siehe Sektion TODOs)
- **Formatter:** ‚ùå NICHT EXPLIZIT KONFIGURIERT (TODO: Prettier Setup fehlt)

### NPM Scripts (aus `package.json`)
```json
{
  "dev": "next dev",
  "build": "next build",
  "start": "next start",
  "lint": "eslint",
  "db:generate": "drizzle-kit generate",
  "db:push": "drizzle-kit push",
  "db:migrate": "tsx scripts/migrate-settings.ts"
}
```

### Seed Scripts (vorhanden)
- `scripts/seed.ts` - erstellt Admin User
- `scripts/seed-data.ts` - erstellt Sample Jobs & Candidates
- `scripts/reset-admin-password.ts` - setzt Admin Passwort zur√ºck
- **Hinweis:** Alle nutzen `tsx` Runner (nicht npm script, manuell ausf√ºhren mit `npx tsx scripts/<file>.ts`)

---

## C) NON-NEGOTIABLE DB RULES (Neon + Drizzle)

### C.1 Schema-√Ñnderungen (Workflow)

**Regel:** Jede Schema√§nderung folgt diesem Ablauf:

1. **Schema aktualisieren** in `src/db/schema.ts`
2. **Migration generieren**: `npm run db:generate`
3. **Migration pr√ºfen**: √ñffne `drizzle/<neue_migration>.sql` und validiere SQL
4. **Migration anwenden** (siehe C.2)
5. **Code anpassen** (Actions, Components, Types)
6. **Tests** (wenn vorhanden)
7. **Quality Gates** laufen lassen (siehe Sektion E)

### C.2 Migration Apply (Commands)

**Lokal/Development:**
```bash
npm run db:push
```
Hinweis: `db:push` ist idempotent und synchronisiert Schema direkt ohne Migrations-Historie (gut f√ºr Prototyping).

**Production/Staging (mit Migration-Historie):**
```bash
npm run db:migrate
```
Hinweis: F√ºhrt `tsx scripts/migrate-settings.ts` aus. **Aktuell ist dieser Script leer** (TODO: siehe Sektion TODOs).

**Alternative (direkt via drizzle-kit):**
```bash
npx drizzle-kit migrate
```
‚ö†Ô∏è **VORSICHT:** Dieser Command ist NICHT in package.json definiert und nutzt Standard drizzle-kit Migrate-Logik. Pr√ºfen, ob Migration-Tracking korrekt funktioniert.

### C.3 Umgang mit Breaking Changes

**Beispiel: Spalte von nullable ‚Üí NOT NULL**

‚ùå **FALSCH** (verursacht Downtime/Fehler):
```sql
ALTER TABLE candidates ALTER COLUMN email SET NOT NULL;
```

‚úÖ **RICHTIG** (phased migration):

**Phase 1** (Migration `000X_make_email_required_prep.sql`):
```sql
-- Spalte ist bereits nullable, Daten backfillen
UPDATE candidates SET email = 'placeholder@xmb-group.ch' WHERE email IS NULL;
```
Deploy ‚Üí Apply ‚Üí Warten bis alle Rows migriert.

**Phase 2** (Migration `000Y_make_email_required_constraint.sql`):
```sql
ALTER TABLE candidates ALTER COLUMN email SET NOT NULL;
```
Deploy ‚Üí Apply.

**Regel:** Zwischen Phase 1 und Phase 2 muss mindestens 1 Deployment-Zyklus liegen.

### C.4 Indizes & Constraints

- **Indizes auf Foreign Keys:** Automatisch von Drizzle generiert bei `.references()`.
- **Custom Indizes:** M√ºssen explizit in Schema definiert werden (z.B. `.index("idx_name")`).
- **Unique Constraints:** Nutze `.unique()` im Schema, nicht manuell in Migration.
- **Check Constraints:** ‚ùå Aktuell nicht im Repo genutzt (TODO: bei Bedarf definieren).

### C.5 Enums

**Im Repo genutzte Enums:**
- `job_type` (contract, permanent)
- `job_status` (draft, published, archived)
- `candidate_status` (new, reviewed, rejected, placed)
- `assignment_status` (proposed, interviewing, offered, rejected, placed)
- `contract_billing` (payroll, company, hybrid)
- `company_type` (ag, gmbh, einzelunternehmen)
- `user_role` (admin, recruiter, viewer)
- `audit_action` (create, update, delete, login, logout, password_reset)

**Enum-√Ñnderungen:**
- Neue Werte hinzuf√ºgen: `ALTER TYPE <enum_name> ADD VALUE '<new_value>';`
- ‚ö†Ô∏è **Entfernen ist NICHT trivial** (erfordert Migration aller Daten + Type Drop + Recreate).

### C.6 Seeds & Test Data

**Bestehende Seeds:**
- `scripts/seed.ts` - Admin User (Email: `admin@xmb-group.ch`, Passwort: `admin123`)
- `scripts/seed-data.ts` - 5 Sample Jobs + 5 Sample Candidates

**Ausf√ºhrung:**
```bash
npx tsx scripts/seed.ts
npx tsx scripts/seed-data.ts
```

**Regel:** Seeds sollten **idempotent** sein (Check ob Daten bereits existieren, dann skip).  
**Status:** ‚ùå Aktuelle Seeds sind NICHT idempotent (TODO: Upserts statt Insert).

### C.7 Niemals tun

- ‚ùå Direkte SQL Queries auf Production DB (au√üer Read-Only via Neon Console f√ºr Debugging)
- ‚ùå Alte Migrationen editieren (Files in `drizzle/` sind immutable nach Apply)
- ‚ùå Journal (`drizzle/meta/_journal.json`) manuell editieren
- ‚ùå Schema und Migrationen out-of-sync lassen
- ‚ùå Migrations auf lokalem Dev-Branch anwenden, dann Branch l√∂schen ohne Merge

---

## D) STANDARD CHANGE WORKFLOW (Step-by-Step)

### Szenario: Feature "Candidate Telefonnummer erforderlich machen"

**1. ANALYSE**
- Welche Tabellen? ‚Üí `candidates`
- Welche Spalte? ‚Üí `phone` (aktuell `text | null`)
- Betroffene API/Actions? ‚Üí `src/actions/candidates.ts`
- Betroffene DTOs/Types? ‚Üí `src/db/schema.ts` (Type Exports)
- Betroffene UI? ‚Üí `src/components/candidates/candidate-form.tsx`
- Breaking Change? ‚Üí Ja (null ‚Üí NOT NULL)

**2. SCHEMA √ÑNDERN**
```typescript
// src/db/schema.ts
export const candidates = pgTable("candidates", {
  // ...existing fields...
  phone: text("phone").notNull(), // war vorher: text("phone")
  // ...existing fields...
});
```

**3. MIGRATION GENERIEREN**
```bash
npm run db:generate
```
**Erwartetes Ergebnis:**
- Neue Datei: `drizzle/0002_<descriptor>.sql`
- Journal Updated: `drizzle/meta/_journal.json` (neuer Entry mit idx=2)

**Pr√ºfung (√∂ffne `drizzle/0002_<descriptor>.sql`):**
```sql
ALTER TABLE "candidates" ALTER COLUMN "phone" SET NOT NULL;
```
‚ö†Ô∏è **Problem:** Wenn bereits NULL-Werte in DB existieren, wird Apply fehlschlagen.

**4. PHASED MIGRATION (falls Breaking)**
**Option A:** Backfill zuerst
```bash
# Manuell SQL in Migration einf√ºgen (vor dem ALTER):
-- Migration: 0002_make_phone_not_null_prep.sql
UPDATE candidates SET phone = '' WHERE phone IS NULL;
ALTER TABLE "candidates" ALTER COLUMN "phone" SET NOT NULL;
```

**Option B:** Zwei separate Migrationen (empfohlen)
```bash
# Migration 0002: Backfill
UPDATE candidates SET phone = '' WHERE phone IS NULL;

# Migration 0003: Constraint
ALTER TABLE "candidates" ALTER COLUMN "phone" SET NOT NULL;
```

**5. MIGRATION ANWENDEN (Lokal)**
```bash
npm run db:push
```
oder
```bash
npm run db:migrate
```
**Erwartetes Ergebnis:**
```
‚úÖ Migration applied successfully
```

**Pr√ºfung:**
```bash
npx drizzle-kit introspect
```
oder direkt in Neon Console: Schema anzeigen, `candidates.phone` sollte `NOT NULL` sein.

**6. CODE √ÑNDERN**

**6a) Actions (`src/actions/candidates.ts`):**
```typescript
// Validation anpassen
const schema = z.object({
  // ...
  phone: z.string().min(1, "Telefon ist erforderlich"), // war vorher: z.string().optional()
  // ...
});
```

**6b) Types (automatisch via Drizzle Infer):**
```typescript
// src/db/schema.ts - Type Exports (keine √Ñnderung n√∂tig, auto-inferiert)
export type Candidate = typeof candidates.$inferSelect;
```

**6c) UI (`src/components/candidates/candidate-form.tsx`):**
```tsx
<Input
  type="tel"
  name="phone"
  required // neu hinzuf√ºgen
  placeholder="+41 79 123 45 67"
/>
```

**7. TESTS (wenn vorhanden)**
‚ùå Aktuell keine Test-Suite im Repo (TODO).

**8. QUALITY GATES (manuell)**
```bash
npm run lint     # ESLint pr√ºfen
npm run build    # TypeScript + Next.js Build
```
**Erwartetes Ergebnis:**
```
‚úì Compiled successfully
```

**9. COMMIT & PR**
```bash
git add drizzle/ src/
git commit -m "feat(candidates): make phone required

- Added NOT NULL constraint to candidates.phone
- Updated validation in candidates actions
- Updated UI form to show required field
- Migration: 0002_make_phone_not_null.sql"
```

---

## E) QUALITY GATES (deterministisch, exakt)

### E.1 Manuelle Gate-Sequenz (aktuell)

**Reihenfolge (zwingend):**
```bash
1. npm run lint                    # ESLint (Fehler ‚Üí STOP)
2. npm run build                   # TypeScript Check + Next.js Build (Fehler ‚Üí STOP)
3. npm run db:push                 # Schema Sync (nur lokal, Test)
4. (TODO) npm test                 # Unit/Integration Tests (wenn vorhanden)
```

**Erfolgskriterium:**
- Alle Commands mit Exit Code 0
- Keine Warnungen in TypeScript Compiler Output
- Keine ESLint Errors (Warnings sind akzeptabel, aber sollten minimiert werden)

### E.2 Single Source of Truth Script

**Status:** ‚úÖ IMPLEMENTIERT (`scripts/ci_local.sh`)

**Implementierung:**
```bash
#!/usr/bin/env bash
set -euo pipefail

echo "üîç Running Quality Gates..."

echo "1Ô∏è‚É£ Format Check..."
# Prettier nicht konfiguriert ‚Üí Skip mit Warning

echo "2Ô∏è‚É£ Linting..."
npm run lint

echo "3Ô∏è‚É£ Type Checking & Build..."
npm run build

echo "4Ô∏è‚É£ Database Schema Validation..."
npx drizzle-kit check

echo "5Ô∏è‚É£ Tests..."
# Test-Suite nicht konfiguriert ‚Üí Skip mit Warning

echo "‚úÖ All gates passed!"
```

**Verwendung:**
```bash
./scripts/ci_local.sh
# oder
npm run ci:local
```

**Quality Gates (in dieser Reihenfolge):**
1. **Format Check** (Prettier) - derzeit √ºbersprungen, da nicht konfiguriert
2. **Lint** (ESLint) - `npm run lint`
3. **TypeCheck & Build** - `npm run build`
4. **Database Migrations** - `npx tsx scripts/migrate-settings.ts` (gegen produktive DB)
5. **Schema Validation** - `npx drizzle-kit check`
6. **Tests** - derzeit √ºbersprungen, da keine Test-Suite konfiguriert

**Features:**
- ‚úÖ Strict Error Handling (`set -euo pipefail`)
- ‚úÖ Exit Code 0 bei Erfolg, 1 bei Fehler
- ‚úÖ Farbige Ausgabe (‚úì/‚úó/‚ö†)
- ‚úÖ Nicht-interaktiv (CI/CD ready)
- ‚úÖ √úberspringt fehlende Features gracefully mit Warnings
- ‚úÖ Referenziert AGENTS.md bei Skips (z.B. "see AGENTS.md J.1.1")
- ‚úÖ L√§dt DATABASE_URL flexibel (aus Environment oder `.env.local`)
- ‚úÖ **Migration Apply immer ausgef√ºhrt** - keine Skips, keine TODOs
- ‚úÖ Idempotentes Migration-Handling - bereits angewendete Migrationen werden erkannt

### E.3 Database Migrations

**Migration-Workflow:**

1. **Schema-√Ñnderungen:**
   ```bash
   # Schema in src/db/schema.ts anpassen
   # Migration generieren
   npx drizzle-kit generate
   ```

2. **Migration Apply:**
   - **Lokal (Development):** Wird automatisch durch `npm run ci:local` ausgef√ºhrt
   - **Production:** Wird automatisch durch `npm run ci:local` vor Deploy ausgef√ºhrt
   
   ```bash
   # Manuelle Migration (falls n√∂tig)
   npx tsx scripts/migrate-settings.ts
   ```

3. **Migration Verify:**
   ```bash
   # Schema-Check (Teil von ci:local)
   npx drizzle-kit check
   ```

**Wichtige Hinweise:**
- ‚úÖ `scripts/migrate-settings.ts` wendet Migrationen aus `./drizzle` an
- ‚úÖ Nutzt `drizzle-orm/neon-http/migrator` mit interner Tracking-Tabelle
- ‚úÖ Idempotent - bereits angewendete Migrationen werden √ºbersprungen
- ‚úÖ Fehlerhandling f√ºr PostgreSQL-Error-Codes (42710, 42P07, 42701)
- ‚ö†Ô∏è  L√§uft gegen produktive Neon-DB (aus `.env.local` oder `DATABASE_URL` ENV)
- ‚ö†Ô∏è  Keine separate Test-DB - Tests laufen gegen gleiche DB wie Development

### E.4 CI/CD (Vercel)

**Automatisch ausgef√ºhrt:**
- `npm run build` (vor Deployment)

**NICHT automatisch ausgef√ºhrt:**
- ‚ùå Tests (keine Test-Suite konfiguriert)

**Empfohlener Workflow:**
1. Entwicklung: `npm run ci:local` ausf√ºhren (inkl. Migrations)
2. PR erstellt ‚Üí Developer f√ºhrt lokal `npm run ci:local` aus
3. PR merged ‚Üí Vercel Build & Deploy
4. **Migrations:** Werden lokal vor Commit via `ci:local` angewendet
   DATABASE_URL="<production_url>" npm run db:migrate
   ```

---

## F) ENVIRONMENTS / NEON HANDLING

### F.1 Environment Files

**Im Repo genutzt:**
- `.env.local` (lokal, NOT committed, muss manuell erstellt werden)
- `.env.local.example` (Template mit ENV key names, committed)
- `.env.test.example` (Template f√ºr Test-DB, committed)

**NICHT vorhanden (aber Standard):**
- `.env.development` (optional)
- `.env.test` (TODO: f√ºr Test-DB, siehe `.env.test.example`)
- `.env.production` (nicht n√∂tig, via Vercel ENV vars)

**Loading:**
- Next.js: Automatisch `.env.local` laden
- Scripts: Explizit via `dotenv.config({ path: ".env.local" })` (siehe `drizzle.config.ts`, alle Scripts in `scripts/`)
- CI Local Script: L√§dt `DATABASE_URL` aus Environment ODER `.env.local` (fallback)

### F.2 Erforderliche ENV Variables

**Production & Development:**
```env
DATABASE_URL="postgresql://user:password@host/database?sslmode=require"
AUTH_SECRET="<min_32_chars_random_string>"  # generieren mit: openssl rand -base64 32
```

**Hinweis zu `DATABASE_URL`:**
- Format: `postgresql://<user>:<password>@<host>/<database>?sslmode=require`
- Neon-spezifisch: Host endet oft auf `.neon.tech`
- **Keine Pooling-URL nutzen** (Neon HTTP driver braucht direkte Connection)

### F.3 Secrets Management

**Regeln:**
- ‚ùå NIEMALS `.env.local` oder `.env` committen (`.gitignore` pr√ºfen)
- ‚ùå NIEMALS Secrets in Code hardcoden
- ‚úÖ Production Secrets nur in Vercel ENV Variables
- ‚úÖ Lokale Secrets in `.env.local` (pers√∂nlich, nicht geteilt)

**Status `.gitignore`:**
TODO: Pr√ºfen ob `.env*` korrekt ignoriert wird.

### F.4 Neon Branching (TODO)

**Neon Feature:** Datenbank-Branches f√ºr Preview Deployments.

**Status:** ‚ùå NICHT KONFIGURIERT (TODO).

**Geplanter Workflow (wenn implementiert):**
1. PR erstellt ‚Üí Neon Branch automatisch erstellen via Vercel Integration
2. Preview Deployment nutzt Branch-DB
3. PR merged ‚Üí Branch wird automatisch gel√∂scht
4. Migrations m√ºssen auch auf Branches applied werden

**Dokumentation:** https://neon.tech/docs/guides/vercel

---

## G) FILE CHANGE BOUNDARIES / GUARDRAILS

### G.1 Core Modules (gesch√ºtzt)

**Diese Ordner/Files d√ºrfen NICHT ohne explizite Anweisung refactored werden:**

- `src/auth.ts` - Auth.js Config (nur bei Auth-Requirements √§ndern)
- `src/db/index.ts` - DB Connection Singleton (nur bei Performance/Connection-Issues √§ndern)
- `src/db/schema.ts` - Schema Source-of-Truth (nur bei DB-Requirements √§ndern)
- `drizzle/` - Migrations (IMMUTABLE nach Apply)
- `drizzle.config.ts` - Drizzle Config (nur bei DB-Setup-√Ñnderungen)

**Kritische Actions (isoliert √§ndern):**
- `src/actions/auth.ts` - Login/Logout/Password Reset
- `src/actions/users.ts` - User Management
- `src/actions/audit-logs.ts` - Audit Logging

### G.2 Feature-bezogene Module (Safe zu √§ndern mit Tests)

**Candidates:**
- `src/actions/candidates.ts`
- `src/components/candidates/`
- `src/app/dashboard/candidates/`

**Jobs:**
- `src/actions/jobs.ts`
- `src/components/jobs/`
- `src/app/dashboard/jobs/`

**Settings:**
- `src/actions/system-settings.ts`
- `src/actions/organizations.ts`
- `src/components/settings/`

### G.3 Default: Kleinste m√∂gliche √Ñnderung

**Prinzip:** Minimal Invasive Surgery

**Beispiel: "F√ºge Feld X zu Candidate hinzu"**
- ‚úÖ √Ñndere nur: Schema + Migration + `candidate-form.tsx` + `candidates.ts` (validation)
- ‚ùå NICHT refactoren: Unrelated Components, Utils, andere Actions

**Ausnahme:** Wenn explizit gefordert ("Refactor gesamte Candidate-Logik").

---

## H) OUTPUT REQUIREMENTS FOR EVERY AI CHANGE

**Bei jeder Implementierung muss der Agent folgendes berichten:**

### H.1 Change Summary (immer)

```markdown
## Implementierung: <Feature/Bugfix Title>

### 1. Ge√§nderte Dateien
- [ ] src/db/schema.ts (Zeile X-Y)
- [ ] drizzle/0003_<descriptor>.sql (neu erstellt)
- [ ] src/actions/candidates.ts (Zeile X-Y)
- [ ] src/components/candidates/candidate-form.tsx (Zeile X-Y)

### 2. Migrationen
- **Neu:** `drizzle/0003_add_candidate_status_field.sql`
- **Applied:** ‚úÖ Lokal (dev DB)
- **Tested:** ‚ùå Noch nicht auf Staging/Production

### 3. Ausgef√ºhrte Commands
```bash
npm run db:generate   # ‚úÖ Success
npm run db:push       # ‚úÖ Success
npm run lint          # ‚úÖ No errors
npm run build         # ‚úÖ Compiled successfully
```

### 4. Type Errors (vor/nach)
- **Vorher:** 3 Errors in `candidate-form.tsx`
- **Nachher:** 0 Errors

### 5. Testanleitung (manuell)
1. `npm run dev`
2. Navigiere zu `/dashboard/candidates/new`
3. Pr√ºfe, dass Feld "Status" vorhanden ist
4. Erstelle Candidate mit Status "new"
5. Pr√ºfe in Neon Console: `SELECT status FROM candidates WHERE id = '<new_id>';`

### 6. Offene Punkte / TODOs
- [ ] E2E Test f√ºr Candidate Creation fehlt (siehe Sektion I)
- [ ] Migration muss auf Staging applied werden (siehe Sektion E.3)
```

### H.2 Migration Details (bei DB-√Ñnderungen, immer)

**Template:**
```markdown
## Migration Details

**File:** `drizzle/0003_add_candidate_status_field.sql`

**SQL:**
```sql
ALTER TABLE "candidates" ADD COLUMN "status" "candidate_status" DEFAULT 'new' NOT NULL;
```

**Breaking:** ‚ùå Nein (Default-Wert gesetzt)

**Rollback-Plan:**
```sql
ALTER TABLE "candidates" DROP COLUMN "status";
```

**Hinweis:** Rollback nur ausf√ºhren, wenn Migration noch nicht auf Production applied.
```

---

## I) "IF YOU ARE UNSURE, STOP" POLICY

### I.1 Stop-Kriterien

**Stoppe die Implementierung und frage nach, wenn:**

1. **Schema-√Ñnderung unklar:**
   - "Soll Spalte nullable sein oder NOT NULL?"
   - "Wie soll Backfill bei Breaking Change erfolgen?"

2. **Betroffene Files unklar:**
   - "Welche Actions/Components m√ºssen angepasst werden?"
   - "Gibt es API-Endpoints, die betroffen sind?" (Aktuell nur Server Actions, keine REST API)

3. **Test-Strategie unklar:**
   - "Wie soll die √Ñnderung getestet werden?" (Manuell/Automatisiert)
   - "Gibt es bereits Tests f√ºr diese Logik?" (Aktuell: Nein, siehe TODOs)

4. **Konflikte mit Core-Modulen:**
   - "√Ñnderung w√ºrde `auth.ts` oder DB Connection Pattern anfassen."

5. **Deployment/Migration unklar:**
   - "Muss Migration vor oder nach Code-Deploy applied werden?"
   - "Gibt es Rollback-Plan?"

### I.2 Output-Format bei Stop

**Template:**
```markdown
## ‚ö†Ô∏è STOP - Fehlende Informationen

Ich kann die Implementierung nicht ohne Kl√§rung fortsetzen.

### Fehlende Fakten
1. [Fakt X nicht vorhanden/unklar]
2. [Fakt Y nicht vorhanden/unklar]

### Offene Fragen (max. 3)
1. [Konkrete Frage 1]?
2. [Konkrete Frage 2]?
3. [Konkrete Frage 3]?

### Vorgeschlagene Optionen
**Option A:** [Beschreibung + Vor-/Nachteile]
**Option B:** [Beschreibung + Vor-/Nachteile]
**Option C:** [Beschreibung + Vor-/Nachteile]

### Empfehlung
Ich empfehle **Option X**, weil [Begr√ºndung].
```

---

## J) TODOs & MISSING INFRASTRUCTURE

**Dieser Abschnitt listet BEKANNTE L√ºcken im Repo auf. Alle AI-√Ñnderungen sollten diese ber√ºcksichtigen.**

### J.1 Kritisch (blockiert saubere Workflows)

1. **Test-Suite fehlt komplett**
   - ‚ùå Kein Test-Runner (Jest/Vitest) konfiguriert
   - ‚ùå Keine Test-Files vorhanden
   - ‚ùå Kein Test-DB Setup
   - **Impact:** √Ñnderungen k√∂nnen nicht automatisiert validiert werden
   - **Empfehlung:** Vitest + Testing Library + Playwright (E2E)
   - **Siehe auch:** `package.json` (kein `test` script)

2. **Migration Apply Script unvollst√§ndig**
   - ‚ùå `scripts/migrate-settings.ts` ist fast leer (nur Seed-Logik)
   - ‚ùå `npm run db:migrate` f√ºhrt KEINE Migrationen aus
   - **Impact:** Production Migrations m√ºssen manuell via `drizzle-kit migrate` oder `db:push` erfolgen
   - **Empfehlung:** Implementiere `migrate-settings.ts` mit `drizzle-orm/neon-http/migrator` (siehe Drizzle Docs)
   - **Workaround:** `npm run db:push` (aber verliert Migration-Historie)

3. **Formatter nicht konfiguriert**
   - ‚ùå Kein Prettier Config
   - ‚ùå Kein Format-Script in `package.json`
   - **Impact:** Inkonsistente Code-Formatierung
   - **Empfehlung:** Prettier + ESLint Integration

4. **Seeds nicht idempotent**
   - ‚ùå `scripts/seed.ts` und `scripts/seed-data.ts` f√ºhren raw Inserts aus
   - **Impact:** Re-run f√ºhrt zu Duplicate-Key Errors
   - **Empfehlung:** Upsert-Logik (ON CONFLICT DO NOTHING)

### J.2 Wichtig (reduziert Effizienz)

5. ~~**Kein CI Local Script**~~ ‚úÖ **ERLEDIGT**
   - ‚úÖ `scripts/ci_local.sh` implementiert
   - ‚úÖ Verwendbar via `./scripts/ci_local.sh` oder `npm run ci:local`
   - ‚úÖ Siehe Sektion E.2

6. **Keine Test-DB Konfiguration**
   - ‚ùå Kein `.env.test`
   - ‚ùå Kein Docker Compose f√ºr lokale Postgres
   - **Impact:** Tests w√ºrden Production/Staging DB nutzen (gef√§hrlich)
   - **Empfehlung:** Neon Branch f√ºr Tests + `.env.test` Setup

7. **Kein Schema Validation Command**
   - ‚ùå Kein `npm run db:check` (pr√ºft Schema-Migration Sync)
   - **Impact:** Drift kann unbemerkt bleiben
   - **Empfehlung:** F√ºge `"db:check": "drizzle-kit check"` zu `package.json` hinzu

### J.3 Nice-to-Have (Optimierungen)

8. **Neon Branching nicht aktiviert**
   - Status: Siehe Sektion F.4

9. **Audit Logs noch nicht voll genutzt**
   - ‚ùå `auditLogs` Table existiert, aber nicht in allen Actions implementiert
   - **Impact:** Unvollst√§ndige Audit Trail
   - **Empfehlung:** Helper Function `logAudit(...)` + Hook in alle CRUD Actions

10. **Type-Safe Env Vars fehlen**
    - ‚ùå Kein `src/env.ts` mit Zod Validation
    - **Impact:** Runtime Errors bei fehlenden ENV vars m√∂glich
    - **Empfehlung:** `@t3-oss/env-nextjs` oder Custom Zod Schema

---

## K) VERWENDETE DATEIEN F√úR DIESES DOKUMENT

**F√ºr Fakten-Extraktion gelesen/analysiert:**

- `package.json` (Scripts, Dependencies)
- `drizzle.config.ts` (Drizzle Setup)
- `src/db/schema.ts` (Schema Source-of-Truth)
- `src/db/index.ts` (DB Connection Pattern)
- `drizzle/` (Migration Files + Journal)
- `scripts/` (Seed Scripts, Migration Script)
- `tsconfig.json` (TypeScript Config)
- `eslint.config.mjs` (Linter Config)
- `next.config.ts` (Next.js Config)
- `README.md` (Deployment Docs)
- `.project_spec.md` (Projekt-Spec)
- `vercel.json` (Vercel Config)

**Nicht gefunden (via file_search):**
- `.env` / `.env.local` (erwartet, da in `.gitignore`)
- Test-Files (`**/*test*`, `**/*spec*`)
- Docker Compose (`**/docker*`)
- CI Config (`.github/workflows/`, `.gitlab-ci.yml`)

---

## L) √ÑNDERUNGSHISTORIE DIESES DOKUMENTS

| Version | Datum | √Ñnderung |
|---------|-------|----------|
| 1.0 | 25.01.2026 | Initial Release - Repository-Scan + Fakten-Extraktion |
| 1.1 | 25.01.2026 | CI Local Script implementiert (E.2), J.2.5 erledigt, ESLint Errors behoben |
| 1.2 | 25.01.2026 | CI Script: DATABASE_URL Handling verbessert (Environment + .env.local), .env.local.example erstellt |

---

**END OF AGENTS.MD**

---

**Verwendung:** Jede AI-Implementierung muss dieses Dokument zu Beginn referenzieren und alle Workflows einhalten.
