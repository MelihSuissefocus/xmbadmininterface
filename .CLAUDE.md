# CLAUDE.md - Permanent Instruction File for Claude Code

**Version:** 1.0  
**Last Updated:** 25. Januar 2026  
**Purpose:** Auto-apply on every prompt. Non-negotiable repo rules.

---

## A) ALWAYS READ FIRST (in order)

1. `AGENTS.md` — Full operating manual, DB rules, stack facts
2. `PROMPTING_RULES.md` — Workflow rules, decision trees, output contracts
3. `SETTINGS_SETUP.md` — Settings migration docs (optional)
4. `MIGRATION_SETUP.md` — Migration setup guide (optional)

---

## B) NON-NEGOTIABLES (12 Rules)

1. **NEVER modify or delete existing migrations** in `drizzle/` after they've been applied.
2. **Every schema change = Drizzle schema update → new migration → apply via `npm run ci:local`.**
3. **`npm run ci:local` MUST be green before any task is marked "done".**
4. **NEVER commit secrets, connection strings, or API keys** to the repository.
5. **NO unsolicited refactors** — only change what the prompt explicitly requests.
6. **Prefer additive DB changes** — new columns ALWAYS nullable OR with default values.
7. **Breaking changes require phased migrations** (e.g., backfill first, constraint second).
8. **NEVER directly write to production DB** — only via migrations.
9. **When uncertain, STOP** — document missing facts, ask max 3 precise questions.
10. **Every DB change must be tracked** — migration file + journal entry + apply log.
11. **Seeds must be idempotent** — check existence before insert.
12. **NEVER edit `drizzle/meta/_journal.json` manually.**

---

## C) DEFAULT EXECUTION WORKFLOW (for any feature)

**Follow this order strictly:**

### Step 1: Impact Analysis
- [ ] Identify affected tables (check `src/db/schema.ts`)
- [ ] Identify affected actions (`src/actions/`)
- [ ] Identify affected UI components (`src/components/`, `src/app/dashboard/`)
- [ ] Determine if breaking change (NULL→NOT NULL, rename, type change)

### Step 2: Data Model Decision
- Enum vs. Lookup Table vs. Junction Table vs. jsonb array
- Document decision with rationale

### Step 3: Schema Update
- Edit `src/db/schema.ts`
- Add columns/tables/relations as needed

### Step 4: Generate Migration
```bash
npm run db:generate
```
- Review generated SQL in `drizzle/<new_file>.sql`
- For breaking changes: add backfill SQL manually

### Step 5: Implementation
- Update actions in `src/actions/`
- Update Zod validation schemas
- Update TypeScript types (auto-inferred from Drizzle)

### Step 6: UI Integration
- Update forms in `src/components/`
- Update pages in `src/app/dashboard/`

### Step 7: Quality Gate
```bash
npm run ci:local
```
**MUST pass all 6 gates:**
1. Format Check (currently skipped)
2. ESLint
3. TypeScript Build
4. Database Migrations
5. Schema Validation (`drizzle-kit check`)
6. Tests (currently skipped)

---

## D) OUTPUT CONTRACT

**After EVERY task, report:**

```markdown
## ✅ Implementation Complete: <Feature Name>

### Files Changed
- `path/to/file.ts` — <brief description>

### DB Changes Summary
- Tables: <list or "None">
- Columns: <list with types>
- Enums: <extensions or "Unchanged">
- Migration: `drizzle/<filename>.sql`

### Commands Run
```bash
npm run db:generate   # ✅ / ❌
npm run ci:local      # ✅ / ❌
```

### Manual Verification Steps
1. <Step 1>
2. <Step 2>

### Open Items
- <TODO or "None">
```

---

## E) REPO FACTS (extracted from repository)

### Package Manager & Scripts
- **Package Manager:** npm
- **Key Scripts:**
  | Command | Description |
  |---------|-------------|
  | `npm run dev` | Start dev server |
  | `npm run build` | Production build (includes TypeScript check) |
  | `npm run lint` | ESLint |
  | `npm run ci:local` | **Main quality gate** — runs all checks |
  | `npm run db:generate` | Generate Drizzle migration |
  | `npm run db:push` | Push schema directly (dev only) |
  | `npm run db:migrate` | Run migration script |

### Paths
| Resource | Path |
|----------|------|
| Drizzle Schema | `src/db/schema.ts` |
| Drizzle Config | `drizzle.config.ts` |
| Migrations | `drizzle/` |
| Migration Journal | `drizzle/meta/_journal.json` |
| CI Script | `scripts/ci_local.sh` |
| Actions | `src/actions/` |
| Components | `src/components/` |
| Dashboard Pages | `src/app/dashboard/` |
| Candidates New Page | `src/app/dashboard/candidates/new/` |

### Tech Stack
- **Framework:** Next.js 16 (App Router)
- **Language:** TypeScript 5.x
- **Database:** Neon PostgreSQL (Serverless)
- **ORM:** Drizzle ORM v0.45.0
- **Auth:** Auth.js v5 (NextAuth)
- **UI:** Radix UI + Tailwind CSS

### Environment Variables (Required)
- `DATABASE_URL` — Neon connection string
- `AUTH_SECRET` — JWT signing secret

---

## F) STOP CONDITIONS

**STOP and document as TODO if:**

- Migration command not found or fails unexpectedly
- Schema file path differs from documented
- Required environment variable missing
- Destructive change implied but not explicitly requested
- External integration/API endpoint unclear
- Two equally valid approaches with no repo precedent

**Format when stopping:**
```markdown
## ⚠️ BLOCKED: <Reason>

**Missing Information:**
- <Item 1>
- <Item 2>

**Files Checked:**
- `path/to/file` — <what was found/not found>

**Proposed Next Steps:**
1. <Option A>
2. <Option B>
```

---

## G) CV AUTO-FILL FEATURE GUIDELINES

**When implementing CV/Document upload features:**

1. **Draft/Review Pattern**
   - NEVER auto-save extracted data directly to DB
   - Always show extracted data in review UI first
   - User must explicitly confirm before save

2. **Confidence & Mapping**
   - Display confidence scores for extracted fields
   - Show unmapped/unrecognized items separately
   - Provide UI for manual field mapping

3. **PII Handling**
   - Redact PII in logs
   - Validate file types (PDF, DOCX only)
   - Enforce file size limits (e.g., 10MB)
   - Enforce page limits (e.g., 20 pages)

4. **UI Requirements**
   - Mapping panel showing: Extracted Value → Target Field
   - Confidence indicator per field
   - List of unmapped items
   - Clear "Confirm & Save" vs "Discard" actions

---

## H) QUICK REFERENCE

```bash
# Full quality gate (run before every commit)
npm run ci:local

# Schema workflow
# 1. Edit src/db/schema.ts
# 2. Generate migration:
npm run db:generate
# 3. Review drizzle/<new>.sql
# 4. Run quality gate:
npm run ci:local

# Dev server
npm run dev

# Seed data (manual)
npx tsx scripts/seed.ts
npx tsx scripts/seed-data.ts
```

---

**END OF CLAUDE.MD**
